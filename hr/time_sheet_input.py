import streamlit as st
from datetime import date, datetime, timedelta
from supabase import create_client, Client

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©
st.set_page_config(page_title="Time Sheet", page_icon="ğŸ“‹")

# Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase
url = st.secrets["url"]
key = st.secrets["key"]
TABLE_NAME = "time_sheet"
supabase: Client = create_client(url, key)

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ù…ÙƒÙ† ØªÙŠØ¬ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù† Supabase)
users = {
    "Ø²ÙŠØ§Ø¯": "1111",
    "Ø¹Ù…Ø±": "2222",
    "Ø¹Ù„ÙŠ": "3333",
    "ÙŠÙˆØ³Ù": "4444"
}

# ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
if "user" not in st.session_state:
    st.session_state["user"] = None
if "login_time" not in st.session_state:
    st.session_state["login_time"] = None

# Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø±ÙˆØ± Ø£Ø³Ø¨ÙˆØ¹
def session_expired():
    if st.session_state["login_time"] is None:
        return True
    return datetime.now() - st.session_state["login_time"] > timedelta(days=7)

# ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠØ¯ÙˆÙŠ
if st.sidebar.button("ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"):
    st.session_state["user"] = None
    st.session_state["login_time"] = None
    st.success("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬")

# Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
def login():
    st.title("ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
    username = st.text_input("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ")
    password = st.text_input("Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ", type="password")
    if st.button("Ø¯Ø®ÙˆÙ„"):
        if username in users and users[username] == password:
            st.session_state["user"] = username
            st.session_state["login_time"] = datetime.now()
            st.success(f"Ù…Ø±Ø­Ø¨Ù‹Ø§ {username} ğŸ‘‹")
            st.experimental_rerun()
        else:
            st.error("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­")

# Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Supabase
def add_time_in(name):
    now = datetime.now().isoformat()
    data = {
        "name": name,
        "date": str(date.today()),
        "from": now,
        "project": "Default"
    }
    try:
        supabase.table(TABLE_NAME).insert(data).execute()
        st.success(f"{name} âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„")
    except Exception as e:
        st.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
        st.write(e)

# Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ Supabase
def add_time_out(name):
    now = datetime.now().isoformat()
    response = supabase.table(TABLE_NAME).select("id").eq("name", name).eq("date", str(date.today())).order("id", desc=True).limit(1).execute()
    if response.data:
        row_id = response.data[0]["id"]
        supabase.table(TABLE_NAME).update({"to": now}).eq("id", row_id).execute()
        st.success(f"{name} â›” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù")
    else:
        st.warning(f"âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø®ÙˆÙ„ Ù…Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… Ù„Ù€ {name}")

# -------------------------
# Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ

# Ù„Ùˆ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù†ØªÙ‡Øª Ø£Ùˆ Ù„Ù… ÙŠØ¨Ø¯Ø£
if st.session_state["user"] is None or session_expired():
    login()
else:
    current_user = st.session_state["user"]
    st.title(f"ğŸ“‹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù - {current_user}")

    col1, col2 = st.columns(2)
    with col1:
        if st.button(f"{current_user} âœ… IN"):
            add_time_in(current_user)
    with col2:
        if st.button(f"{current_user} â›” OUT"):
            add_time_out(current_user)
